<% layout("layouts/boilerplate") %>
<% showNavbar = true %>
<% stickyFooter = false %>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<!-- Search Bar -->
<div class="search-container bg-white shadow-sm sticky-top">
  <div class="container py-3">
    <div class="search-bar bg-white shadow rounded-pill p-2">
      <div class="row g-0 align-items-center">
        <div class="col-lg-3 col-md-6 col-12">
          <div class="search-item border-end">
            <label class="search-label">Where</label>
            <input type="text" class="search-input" placeholder="Search destinations" id="locationSearch">
          </div>
        </div>
        <div class="col-lg-2 col-md-3 col-6">
          <div class="search-item border-end">
            <label class="search-label">Check in</label>
            <input type="date" class="search-input" id="checkinDate">
          </div>
        </div>
        <div class="col-lg-2 col-md-3 col-6">
          <div class="search-item border-end">
            <label class="search-label">Check out</label>
            <input type="date" class="search-input" id="checkoutDate">
          </div>
        </div>
        <div class="col-lg-2 col-md-6 col-12">
          <div class="search-item border-end">
            <label class="search-label">Guests</label>
            <select class="search-input" id="guestCount">
              <option>1 guest</option>
              <option>2 guests</option>
              <option>3 guests</option>
              <option>4+ guests</option>
            </select>
          </div>
        </div>
        <div class="col-lg-2 col-md-6 col-12">
          <div class="search-item">
            <label class="search-label">Price Range</label>
            <select class="search-input" id="priceRange">
              <option>Any price</option>
              <option>₹0 - ₹2,000</option>
              <option>₹2,000 - ₹5,000</option>
              <option>₹5,000 - ₹10,000</option>
              <option>₹10,000+</option>
            </select>
          </div>
        </div>
        <div class="col-lg-1 col-md-6 col-12">
          <button class="search-btn" onclick="performSearch()">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filters & Sorting -->
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h3 class="fw-bold mb-0">All Listings</h3>
    <div class="d-flex gap-2 flex-wrap">
      <select class="form-select form-select-sm" id="sortSelect" onchange="sortListings()">
        <option value="default">Sort by</option>
        <option value="price-low">Price: Low to High</option>
        <option value="price-high">Price: High to Low</option>
        <option value="rating">Rating</option>
        <option value="location">Location</option>
      </select>
      <button class="btn btn-outline-secondary btn-sm" onclick="toggleView()">
        <i class="bi bi-grid" id="viewIcon"></i>
      </button>
    </div>
  </div>

  <!-- Listings Grid -->
  <div class="row g-4" id="listingsContainer">
    <% allListings.forEach((listing, index) => { 
         const url = (listing.image && listing.image.url) 
           ? listing.image.url 
           : (typeof listing.image === 'string' && listing.image.trim() !== '' 
              ? listing.image 
              : '/images/default.jpg');
         
         // Simulate additional data
         const rating = (4.2 + Math.random() * 0.8).toFixed(1);
         const reviewCount = Math.floor(Math.random() * 200) + 20;
         const distance = (Math.random() * 15 + 1).toFixed(1);
         const isuperhost = Math.random() > 0.7;
    %>
      <div class="col-xl-3 col-lg-4 col-md-6 col-12 listing-item" data-price="<%= listing.price %>" data-rating="<%= rating %>" data-location="<%= listing.location %>">
        <div class="card border-0 rounded-4 listing-card h-100" onclick="navigateToListing('<%= listing._id %>')">
          <div class="image-container position-relative rounded-top-4">
            <img src="<%= url %>" class="card-img-top listing-image rounded-top-4" alt="<%= listing.title %>">
            
            <!-- Wishlist Button -->
            <button class="wishlist-btn position-absolute" onclick="event.stopPropagation(); toggleWishlist(this, '<%= listing._id %>')">
              <i class="bi bi-heart" data-id="<%= listing._id %>"></i>
            </button>

            <% if (isuperhost) { %>
            <!-- Superhost Badge -->
            <div class="superhost-badge position-absolute">
              <span class="badge bg-white text-dark fw-semibold">
                <i class="bi bi-award-fill text-warning"></i> Superhost
              </span>
            </div>
            <% } %>
          </div>

          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="fw-semibold mb-0 listing-title"><%= listing.title %></h6>
              <div class="rating-badge">
                <i class="bi bi-star-fill text-warning"></i>
                <span class="fw-semibold"><%= rating %></span>
              </div>
            </div>
            
            <p class="text-muted small mb-1">
              <i class="bi bi-geo-alt-fill me-1"></i>
              <%= listing.location || "Unknown Location" %>
            </p>
            
            <p class="text-muted small mb-2">
              <i class="bi bi-geo me-1"></i>
              <%= distance %> km from city center
            </p>
            
            <p class="text-muted small mb-2">
              <%= reviewCount %> reviews
            </p>
            
            <p class="text-dark fw-semibold mb-0 price-display">
              ₹<%= listing.price.toLocaleString('en-IN') %> <span class="fw-normal text-muted">/ night</span>
            </p>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- Load More Button -->
  <div class="text-center mt-5">
    <button class="btn btn-dark btn-lg rounded-pill px-5" id="loadMoreBtn" onclick="loadMoreListings()">
      Load more listings
    </button>
  </div>
</div>

<!-- Mobile Sticky Bottom Bar -->
<div class="mobile-bottom-bar bg-white shadow-lg d-lg-none">
  <div class="d-flex justify-content-around align-items-center py-2">
    <button class="bottom-nav-btn active" onclick="setActiveTab('search')">
      <i class="bi bi-search"></i>
      <span>Search</span>
    </button>
    <button class="bottom-nav-btn" onclick="setActiveTab('wishlist')">
      <i class="bi bi-heart"></i>
      <span>Wishlist</span>
    </button>
    <button class="bottom-nav-btn" onclick="setActiveTab('trips')">
      <i class="bi bi-calendar"></i>
      <span>Trips</span>
    </button>
    <button class="bottom-nav-btn" onclick="setActiveTab('profile')">
      <i class="bi bi-person"></i>
      <span>Profile</span>
    </button>
  </div>
</div>

<style>
  body { 
    font-family: 'Montserrat', sans-serif; 
    background-color: #f8f9fa; 
    padding-bottom: 80px;
  }

  /* Search Bar Styles */
  .search-container {
    border-bottom: 1px solid #e0e0e0;
    z-index: 1000;
  }

  .search-bar {
    border: 2px solid #e0e0e0;
    max-width: 900px;
    margin: 0 auto;
    transition: all 0.3s ease;
  }

  .search-bar:hover {
    border-color: #333;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  }

  .search-item {
    padding: 12px 20px;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .search-item:hover {
    background-color: #f0f0f0;
    border-radius: 20px;
  }

  .search-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
  }

  .search-input {
    border: none;
    outline: none;
    background: transparent;
    width: 100%;
    font-size: 14px;
    color: #666;
  }

  .search-input::placeholder {
    color: #999;
  }

  .search-btn {
    background: #ff385c;
    border: none;
    color: white;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: auto;
    transition: all 0.3s ease;
  }

  .search-btn:hover {
    background: #e31c5f;
    transform: scale(1.05);
  }

  /* Listing Card Styles */
  .listing-card { 
    transition: all 0.3s ease; 
    border-radius: 1.5rem !important; 
    overflow: hidden; 
    cursor: pointer; 
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .listing-card:hover { 
    transform: translateY(-6px); 
    box-shadow: 0 12px 30px rgba(0,0,0,0.15); 
  }

  .listing-image { 
    width: 100%; 
    height: 260px; 
    object-fit: cover; 
    transition: transform 0.4s ease; 
  }

  .listing-card:hover .listing-image { 
    transform: scale(1.05); 
  }

  .listing-title {
    font-weight: 600;
    font-size: 1rem;
    color: #333;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Wishlist Button */
  .wishlist-btn {
    top: 12px;
    right: 12px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .wishlist-btn:hover {
    background: white;
    transform: scale(1.1);
  }

  .wishlist-btn i {
    font-size: 18px;
    color: #333;
    transition: all 0.3s ease;
  }

  .wishlist-btn.active i {
    color: #ff385c;
  }

  /* Superhost Badge */
  .superhost-badge {
    top: 12px;
    left: 12px;
  }

  .superhost-badge .badge {
    font-size: 11px;
    padding: 6px 10px;
    border-radius: 20px;
  }

  /* Rating Badge */
  .rating-badge {
    font-size: 14px;
    color: #333;
  }

  .rating-badge i {
    font-size: 12px;
    margin-right: 2px;
  }

  /* Price Display */
  .price-display {
    font-size: 16px;
  }

  /* Mobile Bottom Bar */
  .mobile-bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    border-top: 1px solid #e0e0e0;
  }

  .bottom-nav-btn {
    background: none;
    border: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: #999;
    font-size: 12px;
    transition: color 0.3s ease;
    padding: 8px 12px;
    border-radius: 8px;
  }

  .bottom-nav-btn i {
    font-size: 20px;
  }

  .bottom-nav-btn.active {
    color: #ff385c;
  }

  .bottom-nav-btn:hover {
    color: #ff385c;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .search-bar {
      border-radius: 12px !important;
    }
    
    .search-item {
      padding: 10px 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .border-end {
      border-right: none !important;
    }
    
    .listing-image {
      height: 220px;
    }
    
    body {
      padding-bottom: 80px;
    }
  }

  @media (max-width: 576px) {
    .listing-image {
      height: 200px;
    }
    
    .container {
      padding-left: 15px;
      padding-right: 15px;
    }
  }

  /* Loading Animation */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  /* Fade In Animation */
  .fade-in {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  // Wishlist functionality
  let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
  
  function toggleWishlist(button, listingId) {
    const icon = button.querySelector('i');
    const isWishlisted = wishlist.includes(listingId);
    
    if (isWishlisted) {
      wishlist = wishlist.filter(id => id !== listingId);
      button.classList.remove('active');
      icon.classList.remove('bi-heart-fill');
      icon.classList.add('bi-heart');
    } else {
      wishlist.push(listingId);
      button.classList.add('active');
      icon.classList.remove('bi-heart');
      icon.classList.add('bi-heart-fill');
    }
    
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
  }

  // Initialize wishlist buttons
  document.addEventListener('DOMContentLoaded', function() {
    wishlist.forEach(id => {
      const icon = document.querySelector(`i[data-id="${id}"]`);
      if (icon) {
        icon.classList.remove('bi-heart');
        icon.classList.add('bi-heart-fill');
        icon.closest('.wishlist-btn').classList.add('active');
      }
    });
  });

  // Navigation
  function navigateToListing(id) {
    window.location.href = `/listings/${id}`;
  }

  // Sorting functionality
  function sortListings() {
    const sortValue = document.getElementById('sortSelect').value;
    const container = document.getElementById('listingsContainer');
    const items = Array.from(container.children);

    items.sort((a, b) => {
      switch(sortValue) {
        case 'price-low':
          return parseInt(a.dataset.price) - parseInt(b.dataset.price);
        case 'price-high':
          return parseInt(b.dataset.price) - parseInt(a.dataset.price);
        case 'rating':
          return parseFloat(b.dataset.rating) - parseFloat(a.dataset.rating);
        case 'location':
          return a.dataset.location.localeCompare(b.dataset.location);
        default:
          return 0;
      }
    });

    items.forEach(item => {
      item.classList.add('fade-in');
      container.appendChild(item);
    });
  }

  // Search functionality
  function performSearch() {
    const location = document.getElementById('locationSearch').value;
    const checkin = document.getElementById('checkinDate').value;
    const checkout = document.getElementById('checkoutDate').value;
    const guests = document.getElementById('guestCount').value;
    const priceRange = document.getElementById('priceRange').value;

    // Add loading state
    const button = event.target.closest('.search-btn');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
    
    setTimeout(() => {
      button.innerHTML = originalContent;
      // Here you would typically make an API call to filter listings
      console.log('Search params:', { location, checkin, checkout, guests, priceRange });
    }, 1000);
  }

  // Load more functionality
  let currentPage = 1;
  function loadMoreListings() {
    const button = document.getElementById('loadMoreBtn');
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
    button.disabled = true;

    setTimeout(() => {
      // Here you would load more listings from the server
      button.innerHTML = 'Load more listings';
      button.disabled = false;
      currentPage++;
      
      // Hide button after 3 pages (simulation)
      if (currentPage > 3) {
        button.style.display = 'none';
      }
    }, 1500);
  }

  // Mobile bottom navigation
  function setActiveTab(tab) {
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.closest('.bottom-nav-btn').classList.add('active');
    
    console.log('Switched to:', tab);
  }

  // View toggle (grid/list)
  let isGridView = true;
  function toggleView() {
    const container = document.getElementById('listingsContainer');
    const icon = document.getElementById('viewIcon');
    
    if (isGridView) {
      container.className = 'row g-2';
      container.querySelectorAll('.listing-item').forEach(item => {
        item.className = 'col-12 listing-item';
      });
      icon.className = 'bi bi-grid-3x3-gap';
      isGridView = false;
    } else {
      container.className = 'row g-4';
      container.querySelectorAll('.listing-item').forEach(item => {
        item.className = 'col-xl-3 col-lg-4 col-md-6 col-12 listing-item';
      });
      icon.className = 'bi bi-grid';
      isGridView = true;
    }
  }

  // Smooth scrolling for better UX
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      document.querySelector(this.getAttribute('href')).scrollIntoView({
        behavior: 'smooth'
      });
    });
  });

  // Auto-hide search bar on scroll (mobile)
  let lastScrollTop = 0;
  window.addEventListener('scroll', function() {
    if (window.innerWidth <= 768) {
      const currentScroll = window.pageYOffset;
      const searchContainer = document.querySelector('.search-container');
      
      if (currentScroll > lastScrollTop && currentScroll > 100) {
        searchContainer.style.transform = 'translateY(-100%)';
      } else {
        searchContainer.style.transform = 'translateY(0)';
      }
      lastScrollTop = currentScroll;
    }
  });
</script>
