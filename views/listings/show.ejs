<% showNavbar = true %>
<% stickyFooter = true %>
<% layout("layouts/boilerplate") %>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="/node_modules/leaflet/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="/node_modules/leaflet/dist/leaflet.js"></script>
<%
  const reviews = listing.reviews || [];
  const averageRating = reviews.length
    ? (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(2)
    : "N/A";

  const imgUrl = listing.image && listing.image.url
    ? listing.image.url
    : (typeof listing.image === "string" && listing.image.trim() !== ""
      ? listing.image
      : "/images/default.jpg");

  // FIXED: Check owner for secure edit/delete
  const isOwner = currentUser
    && listing.owner
    && String(currentUser._id) === String(listing.owner._id);

  const formatPrice = n => n.toLocaleString('en-IN');
  // Only show rating section if there are actual reviews
  const hasReviews = reviews.length > 0;
  const ratingDistribution = hasReviews ? [0, 0, 0, 0, 0] : []; // Calculate from actual reviews
  const ratingSummary = hasReviews ? [] : []; // Only show if there are reviews
  
  // Helper function to get amenity icons
  function getAmenityIcon(amenity) {
    const iconMap = {
      'Beach access': 'fas fa-water',
      'Fast wifi': 'fas fa-wifi',
      'Free parking': 'fas fa-car',
      'Washer': 'fas fa-soap',
      'Kitchen': 'fas fa-utensils',
      'Dedicated workspace': 'fas fa-briefcase',
      'TV': 'fas fa-tv',
      'Air conditioning': 'fas fa-snowflake',
      'Pool': 'fas fa-swimming-pool',
      'Gym access': 'fas fa-dumbbell',
      'Pet friendly': 'fas fa-paw',
      'Fireplace': 'fas fa-fire',
      'Balcony/Patio': 'fas fa-home',
      'Garden': 'fas fa-leaf',
      'Heating': 'fas fa-thermometer-half',
      'Dryer': 'fas fa-tshirt'
    };
    return iconMap[amenity] || 'fas fa-check';
  }
  
  // REAL AMENITIES from database only
  const amenities = listing.amenities && listing.amenities.length > 0 
    ? listing.amenities.map(amenity => ({
        icon: getAmenityIcon(amenity),
        label: amenity
      }))
    : [];
  
  // Host data is accessed directly from listing.owner

  // Check if user has favorited this listing
  const isFavorited = currentUser && currentUser.favorites && currentUser.favorites.includes(listing._id);
%>

<div class="container-fluid px-0">
  <!-- Hero Image Section -->
  <div class="listing-hero">
    <img src="<%= imgUrl %>" alt="<%= listing.title %>" class="hero-image">
    <div class="hero-overlay">
      <div class="container">
        <div class="hero-content">
          <h1 class="hero-title"><%= listing.title %></h1>
          <div class="hero-details">
            <div class="rating">
              <i class="fas fa-star"></i>
              <span><%= averageRating %></span>
              <span class="review-count">(<%= reviews.length %> reviews)</span>
            </div>
            <div class="location">
              <i class="fas fa-map-marker-alt"></i>
              <span><%= listing.location %>, <%= listing.country %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container my-5">
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div class="flex-grow-1">
      <div class="property-info-card">
        <div class="price-section">
          <h2 class="price">‚Çπ<%= listing.price.toLocaleString('en-IN') %></h2>
          <span class="price-unit">per night</span>
        </div>
        <div class="property-details">
          <% if (listing.maxGuests) { %>
            <span class="detail-item"><i class="fas fa-users"></i> <%= listing.maxGuests %> guests</span>
          <% } %>
          <% if (listing.bedrooms !== undefined) { %>
            <span class="detail-item"><i class="fas fa-bed"></i> <%= listing.bedrooms === 0 ? 'Studio' : `${listing.bedrooms} bed` %></span>
          <% } %>
          <% if (listing.bathrooms) { %>
            <span class="detail-item"><i class="fas fa-bath"></i> <%= listing.bathrooms %> bath</span>
          <% } %>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="d-flex gap-2 flex-wrap">
      <% if (currentUser) { %>
        <button class="action-btn-modern favorite-btn" id="favorite-btn" data-listing-id="<%= listing._id %>">
          <i class="<%= isFavorited ? 'fas' : 'far' %> fa-heart"></i>
        </button>
      <% } %>
      
      <button class="action-btn-modern share-btn" id="share-btn">
        <i class="fas fa-share"></i>
      </button>
    </div>
  </div>

  <div class="row">
    <!-- LEFT COLUMN -->
    <div class="col-lg-8">
      <div class="description-section">
        <h3 class="section-title">About this place</h3>
        <p class="description-text"><%= listing.description %></p>
      </div>
    </div>
    
    <!-- RIGHT COLUMN -->
    <div class="col-lg-4 mt-lg-4">

      <section class="mb-3">
        <h4>What this place offers</h4>
        
        <!-- Visible Amenities (Real data from database) -->
        <div class="row" id="visible-amenities">
          <% amenities.slice(0, 8).forEach((a, i) => { %>
            <div class="col-6">
              <div class="d-flex align-items-center mb-2">
                <i class="<%= a.icon %> me-2 text-dark"></i>
                <span><%= a.label %></span>
              </div>
            </div>
          <% }) %>
        </div>
        
        <!-- Hidden Amenities -->
        <% if (amenities.length > 8) { %>
        <div class="row d-none" id="hidden-amenities">
          <% amenities.slice(8).forEach((a, i) => { %>
            <div class="col-6">
              <div class="d-flex align-items-center mb-2">
                <i class="<%= a.icon %> me-2 text-dark"></i>
                <span><%= a.label %></span>
              </div>
            </div>
          <% }) %>
        </div>
        <% } %>
      </section>
      
      <!-- Enhanced Toggle Button (only if more than 8 amenities) -->
      <% if (amenities.length > 8) { %>
      <button class="btn btn-outline-secondary w-100 mb-3" id="toggle-amenities">
        <span id="amenities-text">Show all <%= amenities.length %> amenities</span>
        <i class="fas fa-chevron-down ms-2" id="amenities-icon"></i>
      </button>
      <% } %>

      <!-- OWNER ONLY Edit/Delete section with Confirmation -->
      <% if(isOwner) { %>
      <div class="d-flex gap-3 mb-4">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-danger flex-grow-1">Edit</a>
        <button class="btn btn-dark flex-grow-1" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
          Delete
        </button>
      </div>
      <% } %>
    </div>
  </div>
  
  <!-- RATING SECTION - Only show if reviews exist -->
  <% if (hasReviews && averageRating !== 'N/A') { %>
  <div class="container-fluid px-0 mb-5">
    <section class="text-center" style="background: #fff; border-bottom: 1px solid #eee; padding-top:2rem;">
      <div class="d-flex justify-content-center align-items-center mb-2" style="width: max-content; margin:auto;">
        <h1 style="font-weight:700; font-size:3rem; margin:0;"><%= averageRating %></h1>
      </div>
      <h3 class="fw-semibold mb-1">Rated by guests</h3>
      <p class="text-muted" style="max-width:320px; margin:auto;">Based on <%= reviews.length %> review<%= reviews.length !== 1 ? 's' : '' %></p>
    </section>
  </div>
  <% } %>
  
  <!-- ENHANCED REVIEWS -->
  <div class="row my-5">
    <div class="col-lg-6">
      <!-- Reviews Header with Sorting -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0">Reviews (<%= reviews.length %>)</h3>
        <% if (reviews.length > 0) { %>
          <select class="form-select form-select-sm" id="review-sort" style="width: auto;">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="highest">Highest rating</option>
            <option value="lowest">Lowest rating</option>
          </select>
        <% } %>
      </div>

      <div id="reviews-container">
        <% if (!reviews.length) { %>
          <div class="text-center py-5">
            <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
            <p class="text-muted">No reviews yet. Be the first to write one!</p>
          </div>
        <% } else { %>
          <div class="d-flex align-items-center mb-4">
            <span class="me-2 fs-2 fw-bold text-dark"><%= averageRating %></span>
            <div class="text-warning me-2">
              <% for (let i = 1; i <= 5; i++) { %>
                <i class="fas fa-star <%= i <= Math.round(averageRating) ? '' : 'text-muted' %>"></i>
              <% } %>
            </div>
            <span class="text-muted">based on <%= reviews.length %> reviews</span>
          </div>
          
          <div id="reviews-list">
            <% reviews.slice(0,3).forEach(r => { %>
            <div class="mb-4 pb-3 border-bottom review-item" data-rating="<%= r.rating %>" data-date="<%= r.createdAt %>">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <strong><%= r.name %></strong>
                <small class="text-muted"><%= new Date(r.createdAt).toLocaleDateString() %></small>
              </div>
              <div class="text-warning mb-2">
                <% for (let i=1; i<=5; i++) { %>
                  <i class="fas fa-star <%= i <= r.rating ? '' : 'text-muted' %>"></i>
                <% } %>
              </div>
              <p class="text-muted mb-1" style="max-height:4.5em; overflow:hidden; text-overflow:ellipsis;">
                <%= r.comment %>
              </p>
              <% if (currentUser && (currentUser.isAdmin || isOwner)) { %>
                <button class="btn btn-sm btn-outline-danger delete-review-btn mt-2" 
                        data-review-id="<%= r._id %>" 
                        data-listing-id="<%= listing._id %>">
                  <i class="fas fa-trash me-1"></i>Delete
                </button>
              <% } %>
            </div>
            <% }) %>
          </div>
          
          <% if (reviews.length > 3) { %>
            <div class="text-center">
              <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#allReviewsModal">
                Show all <%= reviews.length %> reviews
              </button>
            </div>
          <% } %>
        <% } %>
      </div>
    </div>
    
    <div class="col-lg-6">
      <div class="card p-4 mb-4">
        <h4 class="fw-bold mb-3">Add a Review</h4>
        
        <!-- Enhanced Review Form -->
        <form id="review-form" action="/listings/<%= listing._id %>/reviews" method="POST" novalidate>
          <div class="mb-3">
            <input type="text" 
                   id="reviewer-name"
                   name="review[name]" 
                   class="form-control" 
                   placeholder="Your name" 
                   required 
                   minlength="2" 
                   maxlength="100">
            <div class="invalid-feedback">Name must be between 2-100 characters.</div>
          </div>
          
          <div class="mb-3 star-rating d-flex justify-content-center gap-1">
            <% for (let i=1; i<=5; i++) { %>
              <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" required>
              <label for="star<%= i %>" class="fs-3" style="cursor: pointer;">‚òÖ</label>
            <% } %>
            <div class="invalid-feedback d-block">Please select a rating.</div>
          </div>
          
          <div class="mb-3">
            <textarea id="review-comment"
                      name="review[comment]" 
                      class="form-control" 
                      rows="4" 
                      placeholder="Your review" 
                      required 
                      minlength="5" 
                      maxlength="500"></textarea>
            <div class="form-text d-flex justify-content-between">
              <span>Share your experience with this place</span>
              <span><span id="char-count">0</span>/500</span>
            </div>
            <div class="invalid-feedback">Review must be between 5-500 characters.</div>
          </div>
          
          <button type="submit" class="btn btn-primary w-100" id="submit-review-btn">
            <span class="submit-text">Submit Review</span>
            <span class="submit-loading d-none">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Submitting...
            </span>
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- All Reviews Modal (Enhanced) -->
  <div class="modal fade" id="allReviewsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">All Reviews (<%= reviews.length %>)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Modal Review Sorting -->
          <div class="mb-3">
            <select class="form-select" id="modal-review-sort">
              <option value="newest">Newest first</option>
              <option value="oldest">Oldest first</option>
              <option value="highest">Highest rating</option>
              <option value="lowest">Lowest rating</option>
            </select>
          </div>
          
          <div id="modal-reviews-container">
            <% reviews.forEach(r => { %>
              <div class="mb-4 pb-3 border-bottom modal-review-item" data-rating="<%= r.rating %>" data-date="<%= r.createdAt %>">
                <div class="d-flex justify-content-between mb-1">
                  <strong><%= r.name %></strong>
                  <small class="text-muted"><%= new Date(r.createdAt).toLocaleDateString() %></small>
                </div>
                <div class="text-warning mb-2">
                  <% for (let i=1; i<=5; i++) { %>
                    <i class="fas fa-star <%= i <= r.rating ? '' : 'text-muted' %>"></i>
                  <% } %>
                </div>
                <p><%= r.comment %></p>
              </div>
            <% }) %>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- HOST SECTION -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="bg-white p-4 rounded shadow-sm">
        <h4 class="mb-3">Meet your host</h4>
        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <img src="<%= listing.owner.avatar?.url || '/images/default-avatar.jpg' %>" 
                 alt="<%= listing.owner.firstName ? `${listing.owner.firstName} ${listing.owner.lastName || ''}`.trim() : listing.owner.username %>" 
                 class="rounded-circle mb-3" 
                 width="120" 
                 height="120"
                 style="object-fit: cover; border: 3px solid #007bff;"
                 onerror="this.src='/images/default-avatar.jpg'">
            <h5 class="mb-1">
              <%= listing.owner.firstName ? `${listing.owner.firstName} ${listing.owner.lastName || ''}`.trim() : listing.owner.username %>
              <% if (listing.owner.verified) { %>
                <i class="fas fa-check-circle text-primary ms-1" title="Verified"></i>
              <% } %>
            </h5>
            <p class="text-muted mb-0">Joined <%= new Date(listing.owner.createdAt || listing.owner.joinDate).getFullYear() %></p>
          </div>
          <div class="col-md-8">
            <div class="host-details">
              <% if (listing.owner.bio && listing.owner.bio.trim() !== '') { %>
                <div class="mb-3">
                  <h6 class="fw-bold text-dark">About</h6>
                  <p class="mb-0"><%= listing.owner.bio %></p>
                </div>
              <% } %>
              

              
              <% if (listing.owner.hostProfile?.responseTime) { %>
                <div class="mb-3">
                  <h6 class="fw-bold text-dark">Response time</h6>
                  <p class="mb-0 text-success">
                    <i class="fas fa-clock me-1"></i>
                    Responds <%= listing.owner.hostProfile.responseTime %>
                  </p>
                </div>
              <% } %>
              
              <% 
                // Only show additional stats if they exist and are meaningful
                const hasStats = (listing.owner.languages && listing.owner.languages.length > 0) || 
                                (listing.owner.hostProfile?.totalListings && listing.owner.hostProfile.totalListings > 0);
              %>
              <% if (hasStats) { %>
                <div class="row">
                  <% if (listing.owner.languages && listing.owner.languages.length > 0) { %>
                    <div class="col-6">
                      <h6 class="fw-bold text-dark">Languages</h6>
                      <div class="d-flex flex-wrap gap-1">
                        <% listing.owner.languages.forEach(lang => { %>
                          <span class="badge bg-light text-dark border small"><%= lang %></span>
                        <% }) %>
                      </div>
                    </div>
                  <% } %>
                  <% if (listing.owner.hostProfile?.totalListings && listing.owner.hostProfile.totalListings > 0) { %>
                    <div class="col-6">
                      <h6 class="fw-bold text-dark">Total listings</h6>
                      <p class="mb-0"><%= listing.owner.hostProfile.totalListings %></p>
                    </div>
                  <% } %>
                </div>
              <% } %>
              
              <% 
                // If no host profile information is available, show a basic message
                const hasHostInfo = (listing.owner.bio && listing.owner.bio.trim() !== '') ||
                                   (listing.owner.languages && listing.owner.languages.length > 0) ||
                                   (listing.owner.hostProfile?.responseTime);
              %>
              <% if (!hasHostInfo) { %>
                <div class="text-muted">
                  <p class="mb-0">Host profile information will be updated soon.</p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  

  
  <!-- LOCATION SECTION -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="location-section">
        <h4 class="mb-3">Where you'll be</h4>
        <div class="location-info mb-3">
          <p class="location-address">
            <i class="fas fa-map-marker-alt me-2"></i>
            <%= listing.location %>, <%= listing.country %>
          </p>
        </div>
        
        <!-- Interactive Map -->
        <div id="map" class="google-map"></div>
        
        <!-- Location Details -->
        <div class="location-details mt-3">
          <div class="row">
            <div class="col-md-6">
              <h6>Neighborhood highlights</h6>
              <p class="text-muted">Explore the local area and discover nearby attractions, restaurants, and amenities.</p>
            </div>
            <div class="col-md-6">
              <h6>Getting around</h6>
              <p class="text-muted">Easy access to public transportation and major landmarks in <%= listing.location %>.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <%- include('booking-section') %>
</div>

<!-- Delete Confirmation Modal -->
<% if (isOwner) { %>
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Listing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete "<%= listing.title %>"?</p>
        <p class="text-danger small mb-0">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete Listing</button>
        </form>
      </div>
    </div>
  </div>
</div>
<% } %>

<!-- Delete Review Modal -->
<div class="modal fade" id="deleteReviewModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this review?</p>
        <p class="text-danger small mb-0">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="delete-review-form" method="POST">
          <input type="hidden" name="_method" value="DELETE">
          <button type="submit" class="btn btn-danger">Delete Review</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Image Zoom Modal -->
<div class="modal fade" id="imageZoomModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body p-0 text-center">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
        <img id="zoom-image" src="" class="img-fluid rounded" alt="Full size image">
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Styles (keeping your original styling) -->
<style>
  .star-rating input { display: none; }
  .star-rating label { 
    cursor: pointer; 
    color: #adb5bd; 
    font-size: 2rem;
    transition: color 0.2s ease;
    user-select: none;
  }
  .star-rating input:checked ~ label,
  .star-rating label:hover,
  .star-rating label:hover ~ label { color: #ffc107; }
  
  .main-listing-image:hover {
    transform: scale(1.02);
    transition: transform 0.3s ease;
  }
  
  .review-item:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin: -1rem;
    transition: all 0.2s ease;
  }
  
  #amenities-icon {
    transition: transform 0.3s ease;
  }
  
  .btn:focus {
    box-shadow: 0 0 0 0.2rem rgba(254, 66, 77, 0.25);
  }
  
  .btn-primary {
    background-color: #ff385c;
    border-color: #ff385c;
  }
  
  .btn-primary:hover {
    background-color: #e31c5f;
    border-color: #e31c5f;
  }
  
  .form-control.is-invalid {
    animation: shake 0.5s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  
  .booking-card {
    border: 1px solid #ddd;
    border-radius: 12px;
  }
  
  .booking-card .form-control {
    border-radius: 8px;
    border: 1px solid #ddd;
  }
  
  .booking-card .form-control:focus {
    border-color: #ff385c;
    box-shadow: 0 0 0 0.2rem rgba(255, 56, 92, 0.25);
  }
  
  .pricing-breakdown {
    font-size: 14px;
  }
  
  .pricing-breakdown hr {
    margin: 0.5rem 0;
  }
  

  .booking-section {
    border: 2px solid #e9ecef;
    border-radius: 12px;
  }
  
  .pricing-card {
    border: 1px solid #dee2e6;
  }
  
  #bookingForm .form-control:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
  }
  
  /* Google Maps Styles */
  .location-section {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  
  .google-map {
    width: 100%;
    height: 400px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background: #f8f9fa;
  }
  
  .location-address {
    font-size: 1.1rem;
    color: #333;
    margin: 0;
  }
  
  .location-details h6 {
    color: #333;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  @media (max-width: 768px) {
    .google-map {
      height: 300px;
    }
    
    .location-section {
      padding: 1.5rem;
    }
  }
  
  /* Modern Hero Section */
  .listing-hero {
    position: relative;
    height: 60vh;
    min-height: 400px;
    overflow: hidden;
  }
  
  .hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.6));
    display: flex;
    align-items: flex-end;
  }
  
  .hero-content {
    color: white;
    padding: 2rem 0;
  }
  
  .hero-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
  }
  
  .hero-details {
    display: flex;
    gap: 2rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    backdrop-filter: blur(10px);
  }
  
  .rating i {
    color: #ffc107;
  }
  
  .location {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    backdrop-filter: blur(10px);
  }
  
  /* Modern Property Info */
  .property-info-card {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
  }
  
  .price-section {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .price {
    font-size: 2.5rem;
    font-weight: 700;
    color: #007bff;
    margin: 0;
  }
  
  .price-unit {
    font-size: 1.1rem;
    color: #666;
  }
  
  .property-details {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
  
  .detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    font-weight: 500;
  }
  
  .detail-item i {
    color: #007bff;
    width: 16px;
  }
  
  /* Modern Action Buttons */
  .action-btn-modern {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 2px solid #e9ecef;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: #666;
  }
  
  .action-btn-modern:hover {
    border-color: #007bff;
    color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.2);
  }
  
  .favorite-btn.active {
    border-color: #dc3545;
    color: #dc3545;
  }
  
  /* Section Styling */
  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #007bff;
    display: inline-block;
  }
  
  .description-section {
    background: white;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
  }
  
  .description-text {
    font-size: 1.1rem;
    line-height: 1.7;
    color: #555;
  }
  
  @media (max-width: 768px) {
    .hero-title {
      font-size: 2rem;
    }
    
    .hero-details {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .price {
      font-size: 2rem;
    }
    
    .property-details {
      flex-direction: column;
      gap: 1rem;
    }
  }
</style>

<!-- Enhanced JavaScript -->
<script>
// Initialize listing data for JavaScript
window.listingData = {
  id: '<%= listing._id %>',
  title: '<%= listing.title %>',
  location: '<%= listing.location %>',
  country: '<%= listing.country %>',
  price: <%= listing.price %>,
  isFavorited: <%= isFavorited || false %>,
  currentUser: <%= currentUser ? JSON.stringify({id: currentUser._id, isAdmin: currentUser.isAdmin}) : 'null' %>,
  isOwner: <%= isOwner || false %>
};

document.addEventListener('DOMContentLoaded', () => {
  // Original star rating functionality
  const labels = document.querySelectorAll('.star-rating label'),
        inputs = document.querySelectorAll('.star-rating input');
  const highlight = n => labels.forEach((l,i) => l.style.color = i < n ? '#ffc107' : '#adb5bd');
  inputs.forEach((r,i) => {
    r.onchange = () => highlight(i+1);
    labels[i].onmouseenter = () => highlight(i+1);
    labels[i].onmouseleave = () => {
      const c = [...inputs].findIndex(x => x.checked);
      highlight(c+1);
    };
  });
  highlight(0);

  // Enhanced functionality
  setupAmenityToggle();
  setupReviewSorting();
  setupFavoriteButton();
  setupShareButton();
  setupImageZoom();
  setupCharacterCounter();
  setupFormValidation();
  setupDeleteConfirmations();
  setupBookingCalculator();
  setupBookingSection();
});

// Amenity toggle functionality
function setupAmenityToggle() {
  const toggleBtn = document.getElementById('toggle-amenities');
  const hiddenAmenities = document.getElementById('hidden-amenities');
  const amenitiesText = document.getElementById('amenities-text');
  const amenitiesIcon = document.getElementById('amenities-icon');
  
  if (!toggleBtn) return;

  let isExpanded = false;
  toggleBtn.addEventListener('click', () => {
    isExpanded = !isExpanded;
    
    if (isExpanded) {
      hiddenAmenities.classList.remove('d-none');
      amenitiesText.textContent = 'Show less amenities';
      amenitiesIcon.style.transform = 'rotate(180deg)';
    } else {
      hiddenAmenities.classList.add('d-none');
      amenitiesText.textContent = 'Show all <%= amenities.length %> amenities';
      amenitiesIcon.style.transform = 'rotate(0deg)';
    }
  });
}

// Review sorting
function setupReviewSorting() {
  const sortSelects = ['review-sort', 'modal-review-sort'];
  
  sortSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.addEventListener('change', (e) => {
      const isModal = selectId.includes('modal');
      const container = document.getElementById(isModal ? 'modal-reviews-container' : 'reviews-list');
      if (!container) return;

      const reviews = Array.from(container.children);
      const sortBy = e.target.value;
      
      reviews.sort((a, b) => {
        const aRating = parseInt(a.dataset.rating) || 0;
        const bRating = parseInt(b.dataset.rating) || 0;
        const aDate = new Date(a.dataset.date);
        const bDate = new Date(b.dataset.date);
        
        switch(sortBy) {
          case 'newest': return bDate - aDate;
          case 'oldest': return aDate - bDate;
          case 'highest': return bRating - aRating;
          case 'lowest': return aRating - bRating;
          default: return 0;
        }
      });
      
      reviews.forEach(review => container.appendChild(review));
    });
  });
}

// Favorite functionality
function setupFavoriteButton() {
  const favoriteBtn = document.getElementById('favorite-btn');
  if (!favoriteBtn) return;

  favoriteBtn.addEventListener('click', async () => {
    try {
      const listingId = favoriteBtn.dataset.listingId;
      const icon = favoriteBtn.querySelector('i');
      const isFavorited = icon.classList.contains('fas');
      
      // Optimistic update
      if (isFavorited) {
        icon.classList.replace('fas', 'far');
        favoriteBtn.title = 'Add to favorites';
      } else {
        icon.classList.replace('far', 'fas');
        favoriteBtn.title = 'Remove from favorites';
      }

      // API call (implement this endpoint)
      const response = await fetch(`/api/listings/${listingId}/favorite`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!response.ok) {
        // Revert on error
        if (isFavorited) {
          icon.classList.replace('far', 'fas');
          favoriteBtn.title = 'Remove from favorites';
        } else {
          icon.classList.replace('fas', 'far');
          favoriteBtn.title = 'Add to favorites';
        }
        throw new Error('Failed to update favorite');
      }
    } catch (error) {
      console.error('Error toggling favorite:', error);
    }
  });
}

// Share functionality
function setupShareButton() {
  const shareBtn = document.getElementById('share-btn');
  if (!shareBtn) return;
  
  shareBtn.addEventListener('click', async () => {
    const url = window.location.href;
    const title = '<%= listing.title %>';
    
    if (navigator.share) {
      try {
        await navigator.share({ title, url });
      } catch (error) {
        copyToClipboard(url);
      }
    } else {
      copyToClipboard(url);
    }
  });
}

// Image zoom functionality
function setupImageZoom() {
  const mainImage = document.querySelector('.main-listing-image');
  if (!mainImage) return;
  
  mainImage.addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('imageZoomModal'));
    document.getElementById('zoom-image').src = mainImage.src;
    modal.show();
  });
}

// Character counter
function setupCharacterCounter() {
  const commentInput = document.getElementById('review-comment');
  const charCount = document.getElementById('char-count');
  
  if (!commentInput || !charCount) return;
  
  commentInput.addEventListener('input', () => {
    const count = commentInput.value.length;
    charCount.textContent = count;
    
    if (count > 450) {
      charCount.style.color = '#dc3545';
    } else if (count > 400) {
      charCount.style.color = '#ffc107';
    } else {
      charCount.style.color = '#6c757d';
    }
  });
}

// Form validation
function setupFormValidation() {
  const form = document.getElementById('review-form');
  if (!form) return;
  
  form.addEventListener('submit', (e) => {
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
    }
    form.classList.add('was-validated');
  });
}

// Delete confirmations
function setupDeleteConfirmations() {
  const deleteReviewBtns = document.querySelectorAll('.delete-review-btn');
  const deleteReviewForm = document.getElementById('delete-review-form');
  
  deleteReviewBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const reviewId = btn.dataset.reviewId;
      const listingId = btn.dataset.listingId;
      
      if (deleteReviewForm) {
        deleteReviewForm.action = `/listings/${listingId}/reviews/${reviewId}`;
      }
      
      const modal = new bootstrap.Modal(document.getElementById('deleteReviewModal'));
      modal.show();
    });
  });
}

// Booking calculator
function setupBookingCalculator() {
  const checkinInput = document.querySelector('input[name="checkin"]');
  const checkoutInput = document.querySelector('input[name="checkout"]');
  const nightsSpan = document.getElementById('nights');
  const nightsPlural = document.getElementById('nightsPlural');
  const subtotalSpan = document.getElementById('subtotal');
  const serviceFeeSpan = document.getElementById('serviceFee');
  const taxesSpan = document.getElementById('taxes');
  const totalSpan = document.getElementById('total');
  
  if (!checkinInput || !checkoutInput) return;
  
  function calculatePricing() {
    const checkin = new Date(checkinInput.value);
    const checkout = new Date(checkoutInput.value);
    
    if (checkin && checkout && checkout > checkin) {
      const nights = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
      const subtotal = nights * window.listingData.price;
      const serviceFee = Math.round(subtotal * 0.1);
      const taxes = Math.round(subtotal * 0.05);
      const total = subtotal + serviceFee + taxes;
      
      if (nightsSpan) nightsSpan.textContent = nights;
      if (nightsPlural) nightsPlural.textContent = nights === 1 ? '' : 's';
      if (subtotalSpan) subtotalSpan.textContent = '‚Çπ' + subtotal.toLocaleString('en-IN');
      if (serviceFeeSpan) serviceFeeSpan.textContent = '‚Çπ' + serviceFee.toLocaleString('en-IN');
      if (taxesSpan) taxesSpan.textContent = '‚Çπ' + taxes.toLocaleString('en-IN');
      if (totalSpan) totalSpan.textContent = '‚Çπ' + total.toLocaleString('en-IN');
    } else {
      if (nightsSpan) nightsSpan.textContent = '0';
      if (nightsPlural) nightsPlural.textContent = 's';
      if (subtotalSpan) subtotalSpan.textContent = '‚Çπ0';
      if (serviceFeeSpan) serviceFeeSpan.textContent = '‚Çπ0';
      if (taxesSpan) taxesSpan.textContent = '‚Çπ0';
      if (totalSpan) totalSpan.textContent = '‚Çπ0';
    }
  }
  
  checkinInput.addEventListener('change', calculatePricing);
  checkoutInput.addEventListener('change', calculatePricing);
  
  const today = new Date().toISOString().split('T')[0];
  checkinInput.min = today;
  checkoutInput.min = today;
  
  checkinInput.addEventListener('change', () => {
    checkoutInput.min = checkinInput.value;
  });
}

// Booking section setup
function setupBookingSection() {
  const showBookingBtn = document.getElementById('showBookingForm');

  const bookingFormDiv = document.getElementById('bookingForm');
  const cancelBtn = document.getElementById('cancelBooking');
  const submitBtn = document.getElementById('submitBooking');
  const form = document.getElementById('actualBookingForm');
  
  function showBookingForm() {
    if (showBookingBtn) showBookingBtn.style.display = 'none';
    if (bookingFormDiv) {
      bookingFormDiv.classList.remove('d-none');
      bookingFormDiv.scrollIntoView({ behavior: 'smooth' });
    }
  }
  
  if (showBookingBtn) {
    showBookingBtn.addEventListener('click', showBookingForm);
  }
  

  
  if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
      if (bookingFormDiv) bookingFormDiv.classList.add('d-none');
      if (showBookingBtn) showBookingBtn.style.display = 'block';
    });
  }
  
  // Form submission with loading state
  if (form && submitBtn) {
    form.addEventListener('submit', function() {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    });
  }
}

// Utility function
function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Link copied to clipboard!');
    });
  } else {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('Link copied to clipboard!');
  }
}

// Simple booking functionality
document.addEventListener('DOMContentLoaded', function() {
  const bookNowBtn = document.getElementById('showBookingForm');
  const bookingForm = document.getElementById('bookingForm');
  const cancelBtn = document.getElementById('cancelBooking');
  
  if (bookNowBtn && bookingForm) {
    bookNowBtn.addEventListener('click', function() {
      bookNowBtn.style.display = 'none';
      bookingForm.classList.remove('d-none');
      bookingForm.scrollIntoView({ behavior: 'smooth' });
    });
  }
  
  if (cancelBtn && bookingForm && bookNowBtn) {
    cancelBtn.addEventListener('click', function() {
      bookingForm.classList.add('d-none');
      bookNowBtn.style.display = 'block';
    });
  }
});

// Simple Map Initialization
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('map') && typeof L !== 'undefined') {
    // Default coordinates (Delhi, India)
    let lat = 28.6139;
    let lng = 77.2090;
    
    // City coordinates mapping
    const cityCoords = {
      'mumbai': [19.0760, 72.8777],
      'delhi': [28.6139, 77.2090],
      'new delhi': [28.6139, 77.2090],
      'bangalore': [12.9716, 77.5946],
      'bengaluru': [12.9716, 77.5946],
      'chennai': [13.0827, 80.2707],
      'kolkata': [22.5726, 88.3639],
      'hyderabad': [17.3850, 78.4867],
      'pune': [18.5204, 73.8567],
      'goa': [15.2993, 74.1240],
      'panaji': [15.2993, 74.1240],
      'jaipur': [26.9124, 75.7873],
      'manali': [32.2396, 77.1887],
      'shimla': [31.1048, 77.1734],
      'rishikesh': [30.0869, 78.2676],
      'udaipur': [24.5854, 73.7125],
      'agra': [27.1767, 78.0081],
      'varanasi': [25.3176, 82.9739],
      'kochi': [9.9312, 76.2673],
      'cochin': [9.9312, 76.2673],
      'kerala': [10.8505, 76.2711],
      'rajasthan': [26.9124, 75.7873],
      'himachal pradesh': [32.2396, 77.1887],
      'uttarakhand': [30.0869, 78.2676],
      'india': [20.5937, 78.9629]
    };
    
    // Check if listing has stored coordinates first
    <% if (listing.coordinates && listing.coordinates.lat && listing.coordinates.lng) { %>
      lat = <%= listing.coordinates.lat %>;
      lng = <%= listing.coordinates.lng %>;
      console.log('Using stored coordinates:', [lat, lng]);
    <% } else { %>
      // Get location from listing - try exact match first, then partial match
      const listingLocation = '<%= listing.location %>'.toLowerCase().trim();
      
      // Try exact city match first
      if (cityCoords[listingLocation]) {
        [lat, lng] = cityCoords[listingLocation];
        console.log('Found city match:', listingLocation, [lat, lng]);
      } else {
        // Try partial matches for common variations
        for (const [city, coords] of Object.entries(cityCoords)) {
          if (listingLocation.includes(city) || city.includes(listingLocation)) {
            [lat, lng] = coords;
            console.log('Found partial match:', city, [lat, lng]);
            break;
          }
        }
      }
    <% } %>
    
    const listingLocation = '<%= listing.location %>'.toLowerCase().trim();
    const listingCountry = '<%= listing.country %>'.toLowerCase().trim();
    
    // Initialize map
    const map = L.map('map').setView([lat, lng], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add marker
    const marker = L.marker([lat, lng]).addTo(map);
    
    // Add popup with location info
    const isDefaultLocation = (lat === 28.6139 && lng === 77.2090 && listingLocation !== 'delhi');
    const locationText = isDefaultLocation ? 
      `üìç ${listingLocation}, ${listingCountry} (Approximate location)` : 
      `üìç ${listingLocation}, ${listingCountry}`;
    
    marker.bindPopup(`
      <div style="padding: 12px; min-width: 200px;">
        <strong style="color: #333; font-size: 16px;"><%= listing.title %></strong><br>
        <p style="margin: 8px 0; color: #666; font-size: 14px;">${locationText}</p>
        <p style="margin: 0; font-weight: 600; color: #007bff; font-size: 15px;">
          ‚Çπ<%= listing.price.toLocaleString('en-IN') %> per night
        </p>
        ${isDefaultLocation ? '<small style="color: #999;">Exact coordinates may vary</small>' : ''}
      </div>
    `).openPopup();
  }
});
</script>
