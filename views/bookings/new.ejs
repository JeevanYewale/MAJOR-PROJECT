<% showNavbar = true %>
<% layout('layouts/boilerplate') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">Book Your Stay</h3>
        </div>
        <div class="card-body">
          <!-- Listing Info -->
          <div class="listing-info mb-4">
            <div class="row">
              <div class="col-md-4">
                <img src="<%= listing.image?.url || '/images/default.jpg' %>" 
                     alt="<%= listing.title %>" 
                     class="img-fluid rounded">
              </div>
              <div class="col-md-8">
                <h4><%= listing.title %></h4>
                <p class="text-muted">
                  <i class="fas fa-map-marker-alt"></i>
                  <%= listing.location %>, <%= listing.country %>
                </p>
                <p class="h5 text-primary">₹<%= listing.price.toLocaleString('en-IN') %> / night</p>
              </div>
            </div>
          </div>

          <!-- Booking Form -->
          <form action="/bookings/listings/<%= listing._id %>/book" method="POST">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="checkIn" class="form-label">Check-in Date</label>
                <input type="date" class="form-control" id="checkIn" name="checkIn" 
                       min="<%= new Date().toISOString().split('T')[0] %>" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="checkOut" class="form-label">Check-out Date</label>
                <input type="date" class="form-control" id="checkOut" name="checkOut" 
                       min="<%= new Date().toISOString().split('T')[0] %>" required>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="guests" class="form-label">Number of Guests</label>
                <select class="form-select" id="guests" name="guests" required>
                  <% for(let i = 1; i <= listing.maxGuests; i++) { %>
                    <option value="<%= i %>"><%= i %> guest<%= i > 1 ? 's' : '' %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone" name="phone" required>
              </div>
            </div>

            <div class="mb-3">
              <label for="message" class="form-label">Message to Host (Optional)</label>
              <textarea class="form-control" id="message" name="message" rows="3" 
                        placeholder="Tell the host about your trip..."></textarea>
            </div>

            <!-- Price Breakdown -->
            <div class="price-breakdown bg-light p-3 rounded mb-3">
              <h5>Price Breakdown</h5>
              <div class="d-flex justify-content-between">
                <span id="pricePerNight">₹<%= listing.price.toLocaleString('en-IN') %> × <span id="nightCount">0</span> nights</span>
                <span id="subtotal">₹0</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Service fee</span>
                <span id="serviceFee">₹0</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fw-bold">
                <span>Total</span>
                <span id="totalPrice">₹0</span>
              </div>
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-calendar-check me-2"></i>Request to Book
              </button>
              <a href="/listings/<%= listing._id %>" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Listing
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkInInput = document.getElementById('checkIn');
  const checkOutInput = document.getElementById('checkOut');
  const pricePerNight = <%= listing.price %>;
  
  function updatePriceBreakdown() {
    const checkIn = new Date(checkInInput.value);
    const checkOut = new Date(checkOutInput.value);
    
    if (checkIn && checkOut && checkOut > checkIn) {
      const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
      const subtotal = nights * pricePerNight;
      const serviceFee = Math.round(subtotal * 0.1); // 10% service fee
      const total = subtotal + serviceFee;
      
      document.getElementById('nightCount').textContent = nights;
      document.getElementById('subtotal').textContent = '₹' + subtotal.toLocaleString('en-IN');
      document.getElementById('serviceFee').textContent = '₹' + serviceFee.toLocaleString('en-IN');
      document.getElementById('totalPrice').textContent = '₹' + total.toLocaleString('en-IN');
    }
  }
  
  checkInInput.addEventListener('change', function() {
    checkOutInput.min = this.value;
    updatePriceBreakdown();
  });
  
  checkOutInput.addEventListener('change', updatePriceBreakdown);
});
</script>